name: Deploy Betting Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy with Dockerfile Fix
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            echo 'ğŸš€ Ensuring Dockerfile exists...'
            cd /var/www/bet-bot
            
            # Pull code
            git pull origin main
            
            # 1. CREATE DOCKERFILE (MUST EXIST IN ROOT)
            if [ ! -f 'Dockerfile' ]; then
              echo 'ğŸ“ Creating Dockerfile in root directory...'
              cat > Dockerfile << 'DOCKEREOF'
FROM python:3.11-slim
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
RUN chmod +x Docker/entrypoint.sh
ENTRYPOINT [\"Docker/entrypoint.sh\"]
DOCKEREOF
            fi
            
            # 2. CREATE ENTRYPOINT.SH
            mkdir -p Docker
            cat > Docker/entrypoint.sh << 'ENTRYEOF'
#!/bin/bash
cd betting_bot
python manage.py wait_for_db
python manage.py migrate
python manage.py collectstatic --noinput
exec gunicorn betting_bot.betting_bot.wsgi:application --bind 0.0.0.0:8000
ENTRYEOF
            chmod +x Docker/entrypoint.sh
            
            # 3. CREATE WAIT_FOR_DB.PY
            cat > betting_bot/wait_for_db.py << 'PYEOF'
import time, psycopg2
from django.core.management.base import BaseCommand
class Command(BaseCommand):
    def handle(self, *args, **options):
        self.stdout.write('Waiting for database...')
        for i in range(30):
            try:
                conn = psycopg2.connect(
                    host='db', database='betbot', 
                    user='betbot', password='betbot', port=5432
                )
                conn.close()
                self.stdout.write('âœ… Database available!')
                return
            except:
                time.sleep(2)
        self.stdout.write('âŒ Database not available!')
        exit(1)
PYEOF
            
            # 4. UPDATE DOCKER-COMPOSE
            cat > docker-compose.yml << 'COMPOSEEOF'
version: \"3.9\"
services:
  db:
    image: postgres:15
    container_name: bet-bot-db
    restart: always
    environment:
      POSTGRES_DB: betbot
      POSTGRES_USER: betbot
      POSTGRES_PASSWORD: betbot
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: [\"CMD-SHELL\", \"pg_isready -U betbot -d betbot\"]
      interval: 10s
      timeout: 5s
      retries: 5
  web:
    build: .
    container_name: bet-bot-web
    restart: unless-stopped
    ports:
      - \"8000:8000\"
    env_file:
      - .env
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - .:/app
    environment:
      DATABASE_URL: postgres://betbot:betbot@db:5432/betbot
volumes:
  postgres_data:
COMPOSEEOF
            
            # 5. DEPLOY (CLEAN INSTALL)
            echo 'ğŸ³ Cleaning old containers and building...'
            docker-compose down --remove-orphans 2>/dev/null || true
            docker-compose build --no-cache
            docker-compose up -d
            
            echo 'âœ… Deployment complete!'
          "
      
      - name: Verify
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            echo 'ğŸ” Waiting for startup...'
            sleep 30
            
            echo 'ğŸ“‹ Container status:'
            docker-compose ps
            
            echo 'ğŸ“Š Checking web container...'
            WEB_STATUS=\$(docker inspect -f '{{.State.Status}}' bet-bot-web 2>/dev/null || echo 'missing')
            
            if [ \"\$WEB_STATUS\" = \"running\" ]; then
              echo 'âœ… Web container is running!'
              echo 'ğŸ“œ Recent logs:'
              docker-compose logs web --tail=20
            else
              echo 'âŒ Web container status: '\$WEB_STATUS
              echo 'ğŸ”§ Checking Dockerfile location...'
              ls -la /var/www/bet-bot/Dockerfile || echo 'Dockerfile missing!'
              echo 'ğŸ“œ Full logs:'
              docker-compose logs --tail=50
              exit 1
            fi
          "