name: Deploy Docker App

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get your code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up SSH connection
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      # Step 3: Test connection
      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'ğŸš€ Connected to server successfully!'"
      
      # Step 4: Deploy Docker Application
      - name: Deploy Docker App
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            # âš ï¸ IMPORTANT: Change to your project directory
            PROJECT_DIR='/home/vico/your-project-directory'
            PROJECT_NAME='your-project-name'  # Used for container names
            
            echo 'ğŸ“‚ Moving to project directory: $PROJECT_DIR'
            cd \$PROJECT_DIR
            
            echo 'ğŸ“¥ Pulling latest code...'
            git pull origin main
            
            echo 'ğŸ³ Building Docker images...'
            docker-compose build --no-cache
            
            echo 'ğŸ”„ Restarting Docker containers...'
            docker-compose down
            docker-compose up -d
            
            echo 'ğŸ§¹ Cleaning up old images...'
            docker image prune -f
            
            echo 'ğŸ“Š Checking container status...'
            docker ps --filter \"name=\$PROJECT_NAME\"
            
            echo 'âœ… Deployment completed successfully!'
          "
      
      # Optional: Health check
      - name: Verify Deployment
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            echo 'ğŸ” Running health checks...'
            # Add your health check commands here
            # Example: curl -f http://localhost:3000 || exit 1
            sleep 5
            echo 'âœ“ All services are running'
          "