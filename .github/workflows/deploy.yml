name: Deploy Betting Bot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: Prepare Server
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            # Create directory if it doesn't exist
            sudo mkdir -p /var/www/bet-bot
            sudo chown -R vico:vico /var/www/bet-bot
            
            echo 'üìÅ Betting bot directory: /var/www/bet-bot'
            ls -la /var/www/bet-bot/
          "
      
      - name: Copy Files to Server
        run: |
          # Copy all files to the correct location
          scp -i ~/.ssh/id_ed25519 -r ./* ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/var/www/bet-bot/
      
      - name: Deploy Betting Bot
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            echo 'üöÄ Deploying betting bot...'
            cd /var/www/bet-bot
            
            echo 'üì• Pulling latest code (if using git)...'
            # If it's a git repo, uncomment:
            # git pull origin main || true
            
            echo 'üê≥ Stopping old containers...'
            docker-compose down
            
            echo 'üî® Building new containers...'
            docker-compose build --no-cache
            
            echo '‚ö° Starting services...'
            docker-compose up -d
            
            echo '‚è≥ Waiting for services to start...'
            sleep 10
            
            echo 'üîç Checking container status...'
            docker ps --filter \"name=bet_\"
            
            echo 'üìã Viewing logs...'
            docker-compose logs --tail=20
            
            echo '‚úÖ Betting bot deployed to /var/www/bet-bot!'
          "
      
      - name: Verify Deployment
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            echo 'üîß Verification check...'
            
            # Check all 3 services are running
            RUNNING=\$(docker ps --filter \"name=bet_\" --quiet | wc -l)
            echo \"Running betting services: \$RUNNING/3\"
            
            if [ \"\$RUNNING\" -lt 3 ]; then
              echo '‚ö†Ô∏è Some services may have failed. Checking logs...'
              docker-compose logs --tail=50
              exit 1
            else
              echo '‚úì All services running!'
            fi
          "