name: Deploy Betting Bot

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allows manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Get your code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up SSH connection
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
      
      # Step 3: Test connection
      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "echo 'üöÄ Connected to betting bot server!'"
      
      # Step 4: Deploy Betting Bot
      - name: Deploy Betting Bot
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            # Go to betting bot directory
            echo 'üìÇ Moving to betting bot directory...'
            cd /home/vico/betting-bot
            
            # Pull latest code
            echo 'üì• Pulling latest code from GitHub...'
            git pull origin main
            
            # Build and restart Docker containers
            echo 'üê≥ Rebuilding Docker containers...'
            docker-compose build --no-cache
            
            echo 'üîÑ Restarting services...'
            docker-compose down
            docker-compose up -d
            
            # Check if services are running
            echo 'üîç Checking service status...'
            sleep 10  # Wait for containers to start
            docker ps --filter \"name=bet_\"
            
            # View logs if there are issues
            echo 'üìã Checking logs for errors...'
            docker-compose logs --tail=20
            
            echo '‚úÖ Betting bot deployment completed!'
          "
      
      # Optional: Health check
      - name: Verify Services
        run: |
          ssh -i ~/.ssh/id_ed25519 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} "
            echo 'üîç Running health checks...'
            
            # Check if all 3 services are running
            RUNNING_CONTAINERS=\$(docker ps --filter \"name=bet_\" --format \"table {{.Names}}\\t{{.Status}}\" | grep -v NAMES)
            echo \"Running containers:\\n\$RUNNING_CONTAINERS\"
            
            # Count running betting bot containers
            COUNT=\$(echo \"\$RUNNING_CONTAINERS\" | wc -l)
            if [ \"\$COUNT\" -eq 3 ]; then
              echo '‚úì All 3 betting bot services are running!'
            else
              echo \"‚ö†Ô∏è Only \$COUNT/3 services running. Checking logs...\"
              docker-compose logs --tail=30
              exit 1
            fi
          "